<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-light: #FFFAFB; /* Soft pinkish white */
            --surface-light: #ffffff;
            --text-light: #4A4A4A;
            --accent-light: #FF69B4; /* Hot pink */
            --accent-hover-light: #FF3C90;
            --border-light: #FCE4EC;
            --shadow-light: rgba(255, 105, 180, 0.2);

            --background-dark: #2C2C39;
            --surface-dark: #3A3A4A;
            --text-dark: #F5F5F5;
            --accent-dark: #FFC0CB; /* Light pink */
            --accent-hover-dark: #FF94B2;
            --border-dark: #505060;
            --shadow-dark: rgba(0, 0, 0, 0.4);

            /* Default theme */
            --background-color: var(--background-light);
            --surface-color: var(--surface-light);
            --text-color: var(--text-light);
            --accent-color: var(--accent-light);
            --accent-hover-color: var(--accent-hover-light);
            --border-color: var(--border-light);
            --shadow-color: var(--shadow-light);

            --font-family-sans: 'Inter', sans-serif;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
        }

        .dark-mode {
            --background-color: var(--background-dark);
            --surface-color: var(--surface-dark);
            --text-color: var(--text-dark);
            --accent-color: var(--accent-dark);
            --accent-hover-color: var(--accent-hover-dark);
            --border-color: var(--border-dark);
            --shadow-color: var(--shadow-dark);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.4s, color 0.4s;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: var(--space-md);
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg) 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease-in-out;
            outline-offset: 4px;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle svg {
            fill: var(--text-color);
            transition: fill 0.4s;
            width: 24px;
            height: 24px;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: var(--space-2xl);
            flex-grow: 1;
        }

        .input-section, .preview-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: var(--space-xl);
            box-shadow: 0 8px 24px var(--shadow-color);
            transition: box-shadow 0.4s;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.6s ease-out forwards;
        }

        .preview-section {
            animation-delay: 0.2s;
        }
        
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (min-width: 768px) {
            main {
                flex-direction: row;
                gap: var(--space-2xl);
            }
            .input-section, .preview-section {
                flex: 1;
            }
        }

        .prompt-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        label {
            font-weight: 600;
            font-size: 1.1rem;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: var(--space-md);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--background-color);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
            resize: vertical;
            font-size: 1rem;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .button-group {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s, color 0.3s;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover-color);
            box-shadow: 0 6px 15px var(--shadow-color);
        }

        .btn-secondary {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-tertiary {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 8px 16px;
            font-size: 0.875rem;
            box-shadow: none;
        }
        
        .btn-tertiary:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:focus, .btn-secondary:focus, .btn-tertiary:focus, .theme-toggle:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 4px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--space-md);
        }

        .preview-header h2 {
            font-size: 1.5rem;
        }

        #previewIframe {
            width: 100%;
            min-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-message {
            text-align: center;
            font-style: italic;
            color: var(--text-color);
            margin-top: var(--space-lg);
            min-height: 30px;
        }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: var(--space-md) auto;
        }
        
        .content-ideas-section {
            margin-top: var(--space-md);
            padding: var(--space-md);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
        }

        .content-ideas-section h3 {
            margin-bottom: var(--space-sm);
        }

        .content-ideas-section ul {
            padding-left: var(--space-lg);
        }
        
        .image-display {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin-top: var(--space-md);
            border: 1px solid var(--border-color);
        }
        
        #audioPlayer {
            width: 100%;
            margin-top: var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chatbot Styles */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #chat-toggle-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px var(--shadow-color);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #chat-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        #chat-window {
            background-color: var(--surface-color);
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--shadow-color);
            width: 350px;
            height: 500px;
            display: none;
            flex-direction: column;
            margin-top: var(--space-md);
            overflow: hidden;
            transform-origin: bottom right;
            animation: scaleIn 0.3s ease-in-out forwards;
        }

        #chat-window.open {
            display: flex;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #chat-header {
            background-color: var(--accent-color);
            color: white;
            padding: var(--space-md);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }
        
        #chat-close-btn:hover {
            transform: rotate(90deg);
        }

        #chat-history {
            flex-grow: 1;
            padding: var(--space-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .message {
            padding: var(--space-sm);
            border-radius: 12px;
            max-width: 85%;
        }

        .message.user {
            background-color: var(--accent-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background-color: var(--border-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        #chat-input-container {
            display: flex;
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
        }

        #chat-input {
            flex-grow: 1;
            padding: var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
            margin-right: var(--space-sm);
        }

        #chat-send-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: var(--space-sm);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #chat-send-btn:hover {
            background-color: var(--accent-hover-color);
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="header-title">AI Site Creator</h1>
            <button class="theme-toggle" aria-label="Toggle dark mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.5A9.5 9.5 0 0 0 2.5 12a9.5 9.5 0 0 0 9.5 9.5V2.5m0-2.5v19a11.5 11.5 0 0 1-11.5-11.5A11.5 11.5 0 0 1 12 0z"/></svg>
            </button>
        </header>

        <main>
            <section class="input-section">
                <h2>Website Banayein</h2>
                <div class="prompt-container">
                    <label for="promptInput">Apna website idea yahan likhein:</label>
                    <textarea id="promptInput" placeholder="Jaise ki, Ek graphic designer ke liye portfolio website, jismein ek gallery aur contact form ho."></textarea>
                    <div class="button-group">
                        <button id="enhanceBtn" class="btn-tertiary">‚ú® Prompt behtar banayein</button>
                        <button id="ideasBtn" class="btn-tertiary">üí° Content ideas payein</button>
                        <button id="generateImageBtn" class="btn-tertiary">üñºÔ∏è Image banayein</button>
                        <button id="readAloudBtn" class="btn-tertiary">üîä Padh kar sunayein</button>
                    </div>
                </div>
                <div class="button-group">
                    <button id="generateBtn" class="btn-primary">Website banayein</button>
                    <button id="downloadBtn" class="btn-secondary" style="display: none;">Download HTML</button>
                    <button id="downloadXmlBtn" class="btn-secondary" style="display: none;">Download XML</button>
                </div>
                <p id="statusMessage" class="status-message" aria-live="polite"></p>
                <div id="contentIdeas" class="content-ideas-section" style="display:none;">
                    <h3>Content Ideas:</h3>
                    <ul id="ideasList"></ul>
                </div>
                <img id="generatedImage" class="image-display" style="display: none;" alt="Generated image from prompt">
                <audio id="audioPlayer" controls style="display:none;"></audio>
            </section>

            <section class="preview-section">
                <div class="preview-header">
                    <h2>Live Preview</h2>
                </div>
                <div id="previewContainer">
                    <iframe id="previewIframe" title="Website Preview"></iframe>
                </div>
            </section>
        </main>
    </div>

    <!-- Chatbot UI -->
    <div id="chatbot-container">
        <button id="chat-toggle-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
                <path d="M0 0h24v24H0z" fill="none"/>
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8.5 13.5l1.5 1.5 2.5-2.5 1.5 1.5 2.5-2.5 1.5 1.5V11H8.5v2.5z"/>
            </svg>
        </button>
        <div id="chat-window">
            <div id="chat-header">
                <span>AI Assistant</span>
                <button id="chat-close-btn">&times;</button>
            </div>
            <div id="chat-history">
                <div class="message ai">Hi! Main aapki website banane mein madad karne ke liye yahan hoon. Aapko kis tarah ki madad chahiye?</div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Apna sawal likhein...">
                <button id="chat-send-btn">Bhejein</button>
            </div>
        </div>
    </div>
    
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Toggling ---
            const themeToggle = document.querySelector('.theme-toggle');
            const storedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            const setTheme = (theme) => {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            };

            if (storedTheme) {
                setTheme(storedTheme);
            } else if (systemPrefersDark) {
                setTheme('dark');
            }

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });

            // --- AI API Interaction ---
            const API_KEY = "AIzaSyD7KX2uP1S6-520Afbr26uAayOMWD9_9gM"; // <--- Apni API key yahan daalein
            // NOTE: Yeh error API key na hone ke kaaran aa rahi hai. Kripya apni API key ko yahan daalein.
            // Aap apni API key Google AI Studio se prapt kar sakte hain.

            const promptInput = document.getElementById('promptInput');
            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadXmlBtn = document.getElementById('downloadXmlBtn');
            const enhanceBtn = document.getElementById('enhanceBtn');
            const ideasBtn = document.getElementById('ideasBtn');
            const generateImageBtn = document.getElementById('generateImageBtn');
            const readAloudBtn = document.getElementById('readAloudBtn');
            const previewIframe = document.getElementById('previewIframe');
            const statusMessage = document.getElementById('statusMessage');
            const contentIdeas = document.getElementById('contentIdeas');
            const ideasList = document.getElementById('ideasList');
            const generatedImage = document.getElementById('generatedImage');
            const audioPlayer = document.getElementById('audioPlayer');

            // Chatbot Elements
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatWindow = document.getElementById('chat-window');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatHistory = document.getElementById('chat-history');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            // Chat history for context
            let conversationHistory = [{ role: 'model', parts: [{ text: 'Hi! Main aapki website banane mein madad karne ke liye yahan hoon. Aapko kis tarah ki madad chahiye?' }] }];

            function setUiState(isLoading, message = '') {
                generateBtn.disabled = isLoading;
                enhanceBtn.disabled = isLoading;
                ideasBtn.disabled = isLoading;
                generateImageBtn.disabled = isLoading;
                readAloudBtn.disabled = isLoading;
                if (isLoading) {
                    statusMessage.innerHTML = '<div class="spinner"></div><p>' + message + '</p>';
                } else {
                    statusMessage.textContent = message;
                }
            }

            async function callGeminiApi(prompt, model = 'gemini-2.5-flash-preview-05-20') {
                if (!API_KEY) {
                    throw new Error('Please add your API Key in the JavaScript code.');
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (!generatedText) {
                                throw new Error("No content was generated by the AI.");
                            }
                            return generatedText;
                        } else if (response.status === 429 && retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            const errorData = await response.json();
                            throw new Error(`API response was not OK: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorData)}`);
                        }
                    } catch (error) {
                        if (retries < maxRetries - 1 && error.message.includes('Failed to fetch')) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            throw error;
                        }
                    }
                }
            }

            async function generateSite() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    setUiState(false, 'Please enter a description for your website.');
                    return;
                }
                
                setUiState(true, 'Website taiyar ho rahi hai...');
                downloadBtn.style.display = 'none';
                downloadXmlBtn.style.display = 'none';

                const prompt = `You are a professional web developer. Your task is to generate a complete, well-structured, and production-ready single HTML file that includes all necessary CSS and JavaScript. This file should be based on the following user prompt. Ensure the code is responsive, modern, and clean. Use inline CSS in <style> tags and inline JavaScript in <script> tags. The output must be ONLY the full HTML content, starting with <!DOCTYPE html> and ending with </html>. Do not include any extra text, markdown, or comments outside the HTML tags.
                User Prompt: ${userPrompt}`;

                try {
                    const generatedHtml = await callGeminiApi(prompt);
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(generatedHtml, "text/html");
                    if (doc.documentElement.querySelector('parsererror')) {
                        throw new Error("Generated content is not valid HTML. Please try a different prompt.");
                    }

                    previewIframe.srcdoc = generatedHtml;
                    setUiState(false, 'Website safalta-purvak taiyar ho gayi hai!');
                    downloadBtn.style.display = 'inline-block';
                    downloadXmlBtn.style.display = 'inline-block';

                } catch (error) {
                    console.error('Generation Error:', error);
                    setUiState(false, `Error: ${error.message}`);
                    previewIframe.srcdoc = `
                        <div style="font-family: sans-serif; padding: 20px; text-align: center;">
                            <h2 style="color: #d9534f;">Generation Failed</h2>
                            <p>${error.message}</p>
                            <p>Kripya apni API key jaanchein ya alag prompt se phir koshish karein.</p>
                        </div>
                    `;
                }
            }
            
            async function enhancePrompt() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    setUiState(false, 'Please enter a prompt to enhance.');
                    return;
                }
                
                setUiState(true, 'Prompt ko behtar banaya jaa raha hai...');

                const prompt = `Enhance the following brief description into a detailed, professional, and well-structured prompt for a web developer to create a website. The enhanced prompt should be comprehensive, including details about the target audience, tone, required pages/sections, specific features, and design aesthetics. The output should be a single paragraph of text only, without any markdown or extra conversational text.
                Original Prompt: ${userPrompt}`;
                
                try {
                    const enhancedPrompt = await callGeminiApi(prompt);
                    promptInput.value = enhancedPrompt;
                    setUiState(false, 'Prompt safalta-purvak behtar ho gaya!');
                } catch (error) {
                    console.error('Enhancement Error:', error);
                    setUiState(false, `Error: ${error.message}`);
                }
            }

            async function getContentIdeas() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    setUiState(false, 'Please enter a prompt to get ideas for.');
                    return;
                }
                
                setUiState(true, 'Content ideas taiyar ho rahe hain...');
                
                const ideasPrompt = `Based on the following user prompt for a website, generate a list of 5-7 key sections or content ideas that a user should include. The output should be a simple markdown list (e.g., "* Idea 1\n* Idea 2..."). Do not include any extra text or conversation.
                User Prompt: ${userPrompt}`;

                try {
                    const ideasMarkdown = await callGeminiApi(ideasPrompt);
                    const ideasArray = ideasMarkdown.split('*').map(item => item.trim()).filter(Boolean);
                    
                    ideasList.innerHTML = '';
                    ideasArray.forEach(idea => {
                        const li = document.createElement('li');
                        li.textContent = idea;
                        ideasList.appendChild(li);
                    });
                    
                    contentIdeas.style.display = 'block';
                    setUiState(false, 'Content ideas mil gaye!');
                } catch (error) {
                    console.error('Ideas Error:', error);
                    setUiState(false, `Error: ${error.message}`);
                    contentIdeas.style.display = 'none';
                }
            }
            
            async function generateImage() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    setUiState(false, 'Please enter a prompt to generate an image.');
                    return;
                }
                
                setUiState(true, 'Image ban rahi hai...');
                generatedImage.style.display = 'none';

                const payload = { 
                    instances: { 
                        prompt: userPrompt 
                    }, 
                    parameters: { 
                        "sampleCount": 1 
                    } 
                };
                
                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                            if (!base64Data) {
                                throw new Error("No image was generated. Please try a different prompt.");
                            }
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            generatedImage.src = imageUrl;
                            generatedImage.style.display = 'block';
                            setUiState(false, 'Image safalta-purvak ban gayi hai!');
                            return;
                        } else if (response.status === 429 && retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            const errorData = await response.json();
                            throw new Error(`API response was not OK: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorData)}`);
                        }
                    } catch (error) {
                        if (retries < maxRetries - 1 && error.message.includes('Failed to fetch')) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            throw error;
                        }
                    }
                }
            }

            async function readAloud() {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    setUiState(false, 'Please enter a prompt to read aloud.');
                    return;
                }
                
                setUiState(true, 'Audio chal raha hai...');
                audioPlayer.style.display = 'none';
                audioPlayer.pause();
                audioPlayer.src = '';
                
                const payload = {
                    contents: [{
                        parts: [{ text: userPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
                
                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            const part = result?.candidates?.[0]?.content?.parts?.[0];
                            const audioData = part?.inlineData?.data;
                            const mimeType = part?.inlineData?.mimeType;
        
                            if (!audioData || !mimeType || !mimeType.startsWith("audio/")) {
                                throw new Error("No audio content was generated by the AI.");
                            }
                            
                            // Helper functions to convert PCM to WAV, needed for browser playback
                            function base64ToArrayBuffer(base64) {
                                const binaryString = atob(base64);
                                const len = binaryString.length;
                                const bytes = new Uint8Array(len);
                                for (let i = 0; i < len; i++) {
                                    bytes[i] = binaryString.charCodeAt(i);
                                }
                                return bytes.buffer;
                            }
        
                            function pcmToWav(pcm16, sampleRate) {
                                const pcmData = pcm16;
                                const buffer = new ArrayBuffer(44 + pcmData.length * 2);
                                const view = new DataView(buffer);
                                
                                // WAV header
                                function writeString(view, offset, string) {
                                    for (let i = 0; i < string.length; i++) {
                                        view.setUint8(offset + i, string.charCodeAt(i));
                                    }
                                }
                                writeString(view, 0, 'RIFF'); // RIFF identifier
                                view.setUint32(4, 36 + pcmData.length * 2, true); // file length
                                writeString(view, 8, 'WAVE'); // RIFF type
                                writeString(view, 12, 'fmt '); // format chunk identifier
                                view.setUint32(16, 16, true); // format chunk length
                                view.setUint16(20, 1, true); // sample format (1 = PCM)
                                view.setUint16(22, 1, true); // channel count
                                view.setUint32(24, sampleRate, true); // sample rate
                                view.setUint32(28, sampleRate * 2, true); // byte rate
                                view.setUint16(32, 2, true); // block align
                                view.setUint16(34, 16, true); // bits per sample
                                writeString(view, 36, 'data'); // data chunk identifier
                                view.setUint32(40, pcmData.length * 2, true); // data chunk length
                                
                                let offset = 44;
                                for (let i = 0; i < pcmData.length; i++) {
                                    view.setInt16(offset, pcmData[i], true);
                                    offset += 2;
                                }
                                
                                return new Blob([view], { type: 'audio/wav' });
                            }
        
                            const sampleRate = 24000;
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            
                            audioPlayer.src = audioUrl;
                            audioPlayer.style.display = 'block';
                            audioPlayer.play();
                            setUiState(false, 'Audio safalta-purvak chal raha hai!');
                            return;
                        } else if (response.status === 429 && retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            const errorData = await response.json();
                            throw new Error(`API response was not OK: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorData)}`);
                        }
                    } catch (error) {
                        if (retries < maxRetries - 1 && error.message.includes('Failed to fetch')) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            throw error;
                        }
                    }
                }
            }

            function downloadSite() {
                const content = previewIframe.srcdoc;
                if (!content) {
                    statusMessage.textContent = 'Nothing to download. Please generate a site first.';
                    return;
                }
                const blob = new Blob([content], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'generated-site.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            
            function downloadXmlSite() {
                const iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
                if (!iframeDoc || !iframeDoc.body.innerHTML.trim()) {
                    statusMessage.textContent = 'XML download ke liye koi content nahi hai.';
                    return;
                }

                let xmlString = '<?xml version="1.0" encoding="UTF-8"?>\n<website-content>\n';

                const sections = ['header', 'main', 'footer'];
                sections.forEach(sectionTag => {
                    const sectionEl = iframeDoc.querySelector(sectionTag);
                    if (sectionEl) {
                        xmlString += `  <section type="${sectionTag}">\n`;
                        const contentElements = sectionEl.querySelectorAll('h1, h2, h3, p, li, a, span, div');
                        contentElements.forEach(el => {
                            const textContent = el.textContent.trim();
                            if (textContent) {
                                // Sanitize text to prevent XML issues (e.g., <, >, &)
                                const sanitizedText = textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                xmlString += `    <content type="${el.tagName.toLowerCase()}">${sanitizedText}</content>\n`;
                            }
                        });
                        xmlString += '  </section>\n';
                    }
                });

                xmlString += '</website-content>';

                const blob = new Blob([xmlString], { type: 'text/xml' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'generated-site.xml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusMessage.textContent = 'XML file safalta-purvak download ho gaya hai!';
            }
            
            // --- Chatbot Logic ---
            chatToggleBtn.addEventListener('click', () => {
                const isOpen = chatWindow.classList.toggle('open');
                if (isOpen) {
                    chatInput.focus();
                }
            });

            chatCloseBtn.addEventListener('click', () => {
                chatWindow.classList.remove('open');
            });
            
            function addMessageToChat(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.textContent = text;
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to the bottom
            }

            async function handleChatInput() {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                addMessageToChat(userMessage, 'user');
                conversationHistory.push({ role: 'user', parts: [{ text: userMessage }] });
                chatInput.value = '';
                chatInput.disabled = true;
                chatSendBtn.disabled = true;

                addMessageToChat('...', 'ai');
                
                // Add a conversational tone to the prompt
                const systemPrompt = "Aap ek AI assistant hain jo website banane mein madad karte hain. Aapko upyogi, sateek aur dostana tarike se jawab dena hai. Jawab Hindi (Latin) mein likhein.";
                
                const payload = {
                    contents: conversationHistory,
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                
                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const aiResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                            
                            if (aiResponse) {
                                conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                                chatHistory.lastChild.textContent = aiResponse; // Update the '...' message
                            } else {
                                throw new Error('AI response was empty.');
                            }
                            break; // Exit retry loop on success
                        } else if (response.status === 429 && retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            throw new Error(`API error: ${response.status}`);
                        }
                    } catch (error) {
                        chatHistory.lastChild.textContent = 'Maaf kijiye, kuch gadbad ho gayi. Kripya phir se koshish karein.';
                        console.error('Chatbot error:', error);
                        break; // Exit retry loop on fatal error
                    }
                }

                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
            }

            chatSendBtn.addEventListener('click', handleChatInput);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatInput();
                }
            });

            // Event Listeners for main functionality
            generateBtn.addEventListener('click', generateSite);
            enhanceBtn.addEventListener('click', enhancePrompt);
            ideasBtn.addEventListener('click', getContentIdeas);
            generateImageBtn.addEventListener('click', generateImage);
            readAloudBtn.addEventListener('click', readAloud);
            downloadBtn.addEventListener('click', downloadSite);
            downloadXmlBtn.addEventListener('click', downloadXmlSite);
        });
    </script>
</body>
</html>
